[#scenario-04,cols="3"]
.Scenario #4: Scheduling and Resource Limit Failures
|===
| **Mode** | **Components** | **Namespace**

| Easy
| Database, API/Web
| `aap-rh1`
|===

### üìù Objectives

* Log in to the **AAP Gateway UI** (if possible).
* Observe multiple core components failing to deploy or stabilize.
* Diagnose two distinct issues: a pod scheduling failure and a resource limit exhaustion.
* Resolve both issues by modifying the AAP Custom Resource (CR).

---

### üí° Hint

* Use `oc describe pod <failing-pod-name>`:
    * Look for **Events** related to scheduling problems (e.g., "0/X nodes are available: X node(s) didn't match node selector").
    * Look for **Resource** sections to verify if the requested CPU/Memory is excessively high for the cluster capacity.

---

### üõ†Ô∏è Prerequisites: Setup and Break

#### 1. Initial Deployment

[.instruction]
====
Execute the following command, then select **Scenario 4** when prompted.
====

[source,bash]
----
ansible-playbook site.yml -t deploy
----

#### 2. Introduce Failure (Break)

[.instruction]
====
Execute the following command, then select **Scenario 4** when prompted.
====

[source,bash]
----
ansible-playbook site.yml -t break
----

[NOTE]
====
This break introduces an invalid `nodeSelector` for the database and oversized resource limits for the API pods.
====

---

### ‚úÖ Steps to Resolution

#### Step 1: Inspect Database Scheduling

[.instruction]
====
Identify the failing Database pods and describe them to find the scheduling failure reason.
====

[source,bash]
----
oc get pods -n aap-rh1 | grep postgres
oc describe pod <failing-postgres-pod> -n aap-rh1
----

[.output]
====
The events should indicate a `nodeSelector` mismatch.
====

#### Step 2: Inspect API Resource Limits

[.instruction]
====
Identify the failing API pods and describe them to review the requested resource requirements.
====

[source,bash]
----
oc get pods -n aap-rh1 | grep api
oc describe pod <failing-api-pod> -n aap-rh1
----

[.output]
====
The resource section will show requests/limits that exceed typical cluster capacity (e.g., 20Gi memory limit).
====

#### Step 3: Implement the Fixes

[.instruction]
====
Modify the AAP Custom Resource (CR) to:
1. Fix the database `nodeSelector` or remove it.
2. Reduce the API resource requests/limits to manageable values.
====

#### Step 4: Force Reconciliation and Verify

[.instruction]
====
Delete the **Gateway Operator** manager pod to force a reconciliation of the changes, then monitor the pod statuses.
====