= üí° Scenario #2: Solutions and Resolution

This page provides the detailed solution for the issue presented in Scenario #2. Review these steps after you have attempted the diagnosis and resolution yourself.

---

## üõë Problem: Missing ReadWriteMany (RWX) Storage Class

### Diagnosis

The Automation Hub pods were failing due to an inability to provision or mount the required **Persistent Volume Claim (PVC)**. In a typical HA deployment, multiple Hub pods need to access the same storage simultaneously, which requires a storage type that supports the **ReadWriteMany (RWX)** access mode. 

The original StorageClass was set to a type that only supports **ReadWriteOnce (RWO)**, causing PVC binding and pod scheduling failures.

### üõ†Ô∏è Resolution: Updating the Storage Class

The fix involves modifying the main **Ansible Automation Platform Custom Resource (CR)** to specify a valid RWX-capable StorageClass, followed by manually forcing a clean reconciliation.

#### 1. Modify the AAP Custom Resource

If you don't specify a storage class, the operator will use the cluster default storage class. In this case the defualt storage class is RWO storage, Automtaion Hub required RWX storage.

Update the `spec.file_storage_storage_class` field in the `AutomationHub` CR to use an RWX-compatible StorageClass available in your cluster (e.g., `ocs-external-storagecluster-cephfs`).

[.instruction]
====
Edit the AAP CR to add the file_storage_storage_class.
====

[source,yaml]
----
# Example snippet of the modified AAP CR
spec:
  ...
    file_storage_storage_class: ocs-external-storagecluster-cephfs
  ...
----

#### 2. Delete the Old PVC

The existing PVC created with the incorrect StorageClass must be deleted so the Operator can provision a new one.

[.instruction]
====
Identify and delete the PVC associated with the Automation Hub.
====

[source,bash]
----
# Use the correct namespace for your deployment
oc delete pvc -n scenario-2 scenario-2-hub-file-storage
----

#### 3. Delete the hub-api Deployment

The current hub-api deployment is holding on to old information, it needs to be deleted

[.instruction]
====
Identify and delete the deployment associated with the Automation Hub API.
====

[source,bash]
----
# Use the correct namespace for your deployment
oc delete deployment -n scenario-2 scenario-2-hub-api
----

#### 4. Force Reconciliation

Manually delete the key components that manage the Hub to trigger the Operator to recognize the change and provision the new PVC correctly.

[.instruction]
====
Delete the Operator's manager pod and the Hub API Deployment.
====

[source,bash]
----
# 3a. Delete the Hub Operator manager pod
oc get pods -n scenario-2
oc delete pod -n scenario-2 <hub-operator-manager-pod-name> 

----

#### 4. Verification

Monitor the namespace. The Operator will provision a new PVC, redeploy the `hub-api` Deployment, and the Hub pods will successfully mount the volume and transition to a `Running` and `Ready` state.

[source,bash]
----
oc get pods -n scenario-2
----